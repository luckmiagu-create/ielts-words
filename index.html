<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#16a34a">
<link rel="manifest" href="manifest.json">
<title>IELTS 单词记忆同步版</title>

<script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>

<style>
:root{
  --main:#16a34a; --bg:#f0fdf4; --card:#fff; --text:#064e3b; --sub:#4b5563; --danger:#dc2626;
}
*{box-sizing:border-box}
body{ margin:0; font-family:sans-serif; background:var(--bg); color:var(--text); }
.app{max-width:420px;margin:auto;padding:16px 16px 90px}
.card{ background:var(--card); border-radius:18px; padding:18px; box-shadow:0 10px 25px rgba(0,0,0,.1); min-height:200px; }
.question{text-align:center;font-size:26px;font-weight:700;word-break:break-all}
.hint{text-align:center;color:var(--sub);margin-top:6px}
input,textarea{ width:100%; padding:14px; font-size:16px; border-radius:14px; border:2px solid #d1fae5; margin-top:12px; outline:none; }
.result{text-align:center;margin-top:10px;font-size:18px;font-weight:600}
.correct{color:var(--main)}
.wrong{color:var(--danger)}
.answer{text-align:center;margin-top:6px;min-height:1.2em}
.row{display:flex;gap:10px;justify-content:center;margin-bottom:12px}
button{ padding:10px 14px; border:none; border-radius:14px; background:var(--main); color:#fff; font-size:14px; cursor:pointer; }
.secondary{background:#6b7280}
.outline{background:transparent; border: 1px solid var(--main); color: var(--main);}
.fab{ position:fixed; right:18px; bottom:18px; width:60px; height:60px; border-radius:50%; background:var(--main); color:#fff; font-size:32px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 25px rgba(0,0,0,.3); z-index:999; }
#addPanel{ position:fixed; left:0;right:0;bottom:0; background:#fff; padding:20px; border-radius:20px 20px 0 0; display:none; box-shadow:0 -5px 20px rgba(0,0,0,0.1); z-index:1000; max-height:80vh; overflow-y:auto; }
</style>
</head>

<body>
<div class="app">
  <div class="row">
    <button onclick="setMode('en2cn')" id="btnEn">英→汉</button>
    <button onclick="setMode('cn2en')" id="btnCn" class="secondary">汉→英</button>
    <button onclick="togglePool()" id="btnPool" class="secondary">全部</button>
  </div>

  <div class="card">
    <div class="question" id="q">同步数据中...</div>
    <div class="hint" id="hint"></div>
    <input id="input" placeholder="输入答案，回车确认">
    <div class="result" id="result"></div>
    <div class="answer" id="answer"></div>
    
    <div class="row" style="margin-top:20px">
      <button onclick="prev()" class="outline">上一个</button>
      <button onclick="next()" class="outline">下一个</button>
    </div>
  </div>
</div>

<div class="fab" onclick="toggleAdd()">+</div>

<div id="addPanel">
  <h3 style="margin:0">添加单词</h3>
  <input id="newEn" placeholder="英文">
  <input id="newCn" placeholder="中文">
  <button onclick="add()" style="width:100%;margin-top:10px">保存单个</button>
  <hr style="margin:20px 0; border:none; border-top:1px solid #eee">
  <h3 style="margin:0">批量导入 (英文:中文)</h3>
  <textarea id="batchInput" rows="4" placeholder="apple:苹果&#10;banana:香蕉"></textarea>
  <button onclick="batchAdd()" style="width:100%;margin-top:10px;background:#059669">批量保存并同步</button>
  <button onclick="toggleAdd()" class="secondary" style="width:100%;margin-top:8px">关闭</button>
</div>

<script>
// --- LeanCloud 初始化 (请务必填写你自己的凭证) ---
AV.init({
  appId: "ezJjMBF0ioTdPd21imL1RQ8y-gzGzoHsz",
  appKey: "7CGxTy5W8FOeVyJRT1BSqaq3",
  serverURL: "https://ezjjmbf0.lc-cn-n1-shared.com"
});
const STORAGE_ID = "my_ielts_words_v1"; 

let words = JSON.parse(localStorage.getItem("words")) || [];
let index = 0, mode = "en2cn", pool = "all";

// 3. 核心逻辑：云端同步函数
async function syncFromCloud() {
  const query = new AV.Query('WordData');
  query.equalTo('storageId', STORAGE_ID);
  try {
    const result = await query.first();
    if (result) {
      words = result.get('content');
      localStorage.setItem("words", JSON.stringify(words));
      render();
    } else {
      q.textContent = "词库为空，请添加";
    }
  } catch(e) { console.log("离线模式"); render(); }
}

async function save() {
  localStorage.setItem("words", JSON.stringify(words));
  const query = new AV.Query('WordData');
  query.equalTo('storageId', STORAGE_ID);
  let record = await query.first();
  if (!record) {
    const WordData = AV.Object.extend('WordData');
    record = new WordData();
    record.set('storageId', STORAGE_ID);
  }
  record.set('content', words);
  await record.save();
}

// --- 原有逻辑增强 ---
function list() {
  return pool === "wrong" ? words.filter(w => w.wrong) : words;
}

function render() {
  const l = list();
  if(!l.length) { q.textContent = pool === "wrong" ? "没用错题！" : "请添加单词"; return; }
  if(index < 0) index = l.length - 1;
  const current = l[index % l.length];
  q.textContent = mode === "en2cn" ? current.en : current.cn;
  hint.textContent = `第 ${index + 1}/${l.length} 个 | ${mode === "en2cn" ? "中" : "英"}`;
  input.value = ""; result.textContent = ""; answer.textContent = "";
}

function next() { index++; render(); }
function prev() { index--; render(); }

input.onkeydown = e => {
  if(e.key === "Enter") {
    const v = input.value.trim().toLowerCase();
    const l = list();
    const current = l[index % l.length];
    let ok = mode === "en2cn" ? current.cn.includes(v) : v === current.en.toLowerCase();
    
    if(ok && v !== "") {
      result.textContent = "✅ 正确"; result.className = "result correct";
      current.wrong = 0; save();
      setTimeout(next, 800);
    } else {
      result.textContent = "❌ 错误"; result.className = "result wrong";
      current.wrong = 1; save();
      answer.textContent = "答案：" + (mode === "en2cn" ? current.cn : current.en);
    }
  }
};

function toggleAdd() { addPanel.style.display = addPanel.style.display === "block" ? "none" : "block"; }

function add() {
  if(!newEn.value || !newCn.value) return;
  words.push({en: newEn.value.toLowerCase(), cn: newCn.value, wrong: 0});
  save(); newEn.value = ""; newCn.value = ""; alert("保存成功并同步"); render();
}

function batchAdd() {
  const text = batchInput.value.trim();
  if(!text) return;
  text.split('\n').forEach(line => {
    const parts = line.split(/[:：]/);
    if(parts.length >= 2) words.push({en: parts[0].trim().toLowerCase(), cn: parts[1].trim(), wrong: 0});
  });
  save(); batchInput.value = ""; toggleAdd(); alert("批量导入成功"); render();
}

function setMode(m) { mode = m; render(); }
function togglePool() { 
  pool = pool === "all" ? "wrong" : "all"; 
  btnPool.textContent = pool === "all" ? "全部" : "错题";
  index = 0; render(); 
}

// 页面加载自动同步
window.onload = syncFromCloud;
</script>
</body>
</html>