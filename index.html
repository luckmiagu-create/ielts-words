<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é›…æ€å•è¯è®°å¿† Â· æœ€ç»ˆå¢å¼ºç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4f46e5">
<link rel="manifest" href="manifest.json">

<style>
:root{--bg:#f5f7fa;--card:#fff;--text:#111;--sub:#6b7280;--btn:#4f46e5}
.dark{--bg:#111827;--card:#1f2937;--text:#f9fafb;--sub:#9ca3af;--btn:#6366f1}
body{margin:0;background:var(--bg);color:var(--text);
font-family:Arial,"PingFang SC","Microsoft YaHei"}
.app{max-width:860px;margin:auto;padding:16px}
.card{background:var(--card);padding:20px;border-radius:16px;
box-shadow:0 8px 18px rgba(0,0,0,.15)}
h1{text-align:center}
.row{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:8px 0}
button{padding:8px 14px;border:none;border-radius:8px;
background:var(--btn);color:#fff;cursor:pointer}
.secondary{background:#64748b}
.danger{background:#dc2626}
.question{font-size:26px;font-weight:bold;text-align:center}
.hint{text-align:center;color:var(--sub);margin-top:6px}
input,textarea{width:80%;padding:10px;font-size:16px;margin:8px auto;display:block}
textarea{height:120px}
.answer{text-align:center;margin-top:8px;display:none}
.stats{text-align:center;font-size:14px;color:var(--sub);margin-top:10px}
</style>

<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>navigator.serviceWorker.register("service-worker.js"));
}
</script>
</head>

<body>
<div class="app">
<h1>é›…æ€å•è¯è®°å¿† Â· æœ€ç»ˆå¢å¼ºç‰ˆ</h1>

<div class="row">
  <button onclick="setMode('en2cn')">è‹±â†’æ±‰</button>
  <button onclick="setMode('cn2en')" class="secondary">æ±‰â†’è‹±</button>
  <button onclick="toggleDark()" class="secondary">ğŸŒ™</button>
</div>

<div class="row">
  <button onclick="setPool('all')">ğŸ“š å…¨éƒ¨</button>
  <button onclick="setPool('due')" class="secondary">â° ä»Šæ—¥</button>
  <button onclick="setPool('wrong')" class="secondary">ğŸ“• é”™è¯</button>
</div>

<div class="card">
  <div class="question" id="q"></div>
  <div class="hint" id="hint"></div>
  <input id="input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" enterkeyhint="done">
  <div class="answer" id="answer"></div>
</div>

<div class="row">
  <button onclick="grade(true)">âœ” è®°ä½</button>
  <button onclick="grade(false)" class="secondary">âœ– å¿˜è®°</button>
  <button onclick="showAnswer()">ğŸ‘€ ç­”æ¡ˆ</button>
  <button onclick="deleteCurrent()" class="danger">ğŸ—‘ åˆ é™¤</button>
</div>

<div class="row">
  <button onclick="toggleAdd()" class="secondary">â• æ·»åŠ å•è¯</button>
</div>

<div class="stats" id="stats"></div>

<!-- æ·»åŠ å•è¯ -->
<div id="addPanel" class="card" style="display:none;margin-top:12px">
  <h3 style="text-align:center">â• æ·»åŠ å•è¯</h3>

  <div class="row">
    <button onclick="setAddMode('single')">å•ä¸ª</button>
    <button onclick="setAddMode('batch')" class="secondary">æ‰¹é‡</button>
  </div>

  <div id="singleAdd">
    <input id="newEn" placeholder="è‹±æ–‡">
    <input id="newCn" placeholder="ä¸­æ–‡">
    <button onclick="addSingle()">ä¿å­˜</button>
  </div>

  <div id="batchAdd" style="display:none">
    <textarea id="batchText" placeholder="abandon=æ”¾å¼ƒ"></textarea>
    <button onclick="addBatch()">æ‰¹é‡å¯¼å…¥</button>
  </div>

  <div class="row">
    <button onclick="toggleAdd()" class="secondary">å…³é—­</button>
  </div>
</div>
</div>

<script>
/* ================= äº‘åŒæ­¥é…ç½® ================= */
const GIST_ID = "c88623c432a37c3a1ab1dd9f2ba551fb";
const GIST_TOKEN = "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";

/* ================= åŸºç¡€æ•°æ® ================= */
const DAY = 86400000;
let mode="en2cn", pool="all", current=null, addMode="single";
let syncTimer=null;
let dark = localStorage.getItem("dark")==="1";

let words = JSON.parse(localStorage.getItem("words")) || [
  make("abandon","æ”¾å¼ƒ"),
  make("accurate","å‡†ç¡®çš„"),
  make("analyze","åˆ†æ")
];
let logs = JSON.parse(localStorage.getItem("logs")) || [];

/* ================= SRS ================= */
function make(en,cn){
  return {en,cn,ease:2.5,interval:0,due:0,wrong:0}
}
function schedule(w,ok){
  if(ok){
    w.ease=Math.max(1.3,w.ease+0.1);
    w.interval=w.interval?Math.round(w.interval*w.ease):1;
    w.wrong=0;
  }else{
    w.ease=Math.max(1.3,w.ease-0.2);
    w.interval=1;
    w.wrong++;
  }
  w.due=Date.now()+w.interval*DAY;
}

/* ================= é¢˜åº“ ================= */
function getPool(){
  if(pool==="due") return words.filter(w=>w.due<=Date.now());
  if(pool==="wrong") return words.filter(w=>w.wrong||w.ease<2.3);
  return words;
}

function setMode(m){mode=m;next()}
function setPool(p){pool=p;next()}
function showAnswer(){answer.style.display="block"}
function toggleDark(){
  dark=!dark;
  document.body.classList.toggle("dark",dark);
  localStorage.setItem("dark",dark?"1":"0");
}

/* ================= ä¸»æµç¨‹ ================= */
function next(){
  const list=getPool();
  if(!list.length){
    q.textContent="ğŸ‰ æš‚æ— å¯å¤ä¹ å•è¯";
    hint.textContent="";
    return;
  }
  current=list[Math.floor(Math.random()*list.length)];
  render();
}
function render(){
  q.textContent=(mode==="cn2en"?"æ±‰è¯‘è‹±ï¼š":"è‹±è¯‘æ±‰ï¼š")+
    (mode==="cn2en"?current.cn:current.en);
  hint.textContent=mode==="cn2en"
    ?current.en.slice(0,2)+" _ ".repeat(current.en.length-2)
    :current.cn[0]+"â–¡".repeat(current.cn.length-1);
  answer.textContent="ç­”æ¡ˆï¼š"+(mode==="cn2en"?current.en:current.cn);
  answer.style.display="none";
  input.value="";
  stats.textContent=statText();
}

/* ================= ç­”é¢˜ï¼ˆå«å›è½¦ï¼‰ ================= */
function grade(forceOk){
  let ok=forceOk;
  if(forceOk){
    const v=input.value.trim();
    if(mode==="cn2en" && v.toLowerCase()!==current.en) ok=false;
    if(mode==="en2cn" && !current.cn.includes(v)) ok=false;
  }
  schedule(current,ok);
  logs.push({t:Date.now(),ok});
  save();
  next();
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    grade(true);
  }
});

/* ================= ç»Ÿè®¡ ================= */
function statText(){
  const now=Date.now();
  return `è¯åº“ï¼š${words.length} ï½œ 7å¤©ï¼š${logs.filter(l=>now-l.t<7*DAY).length} ï½œ 30å¤©ï¼š${logs.filter(l=>now-l.t<30*DAY).length}`;
}

/* ================= æ·»åŠ  / åˆ é™¤ ================= */
function toggleAdd(){addPanel.style.display=addPanel.style.display==="none"?"block":"none";}
function setAddMode(m){
  addMode=m;
  singleAdd.style.display=m==="single"?"block":"none";
  batchAdd.style.display=m==="batch"?"block":"none";
}
function addSingle(){
  const en=newEn.value.trim().toLowerCase(),cn=newCn.value.trim();
  if(!en||!cn)return alert("è¯·è¾“å…¥å®Œæ•´");
  if(words.find(w=>w.en===en))return alert("å·²å­˜åœ¨");
  words.push(make(en,cn));
  save();next();alert("å·²æ·»åŠ ");
}
function addBatch(){
  let c=0;
  batchText.value.split(/\r?\n/).forEach(l=>{
    if(l.includes("=")){
      const [en,cn]=l.split("=");
      if(en&&cn&&!words.find(w=>w.en===en.trim().toLowerCase())){
        words.push(make(en.trim().toLowerCase(),cn.trim()));
        c++;
      }
    }
  });
  save();next();alert(`æ‰¹é‡æ·»åŠ  ${c} ä¸ª`);
}
function deleteCurrent(){
  if(current&&confirm(`åˆ é™¤ ${current.en}ï¼Ÿ`)){
    words=words.filter(w=>w!==current);
    save();next();
  }
}

/* ================= è‡ªåŠ¨äº‘åŒæ­¥ ================= */
async function syncFromCloud(){
  try{
    const r=await fetch(`https://api.github.com/gists/${GIST_ID}`);
    const j=await r.json();
    if(j.files?.["ielts_words.json"]){
      const d=JSON.parse(j.files["ielts_words.json"].content);
      words=d.words||words;
      logs=d.logs||logs;
      save(false);
    }
  }catch(e){}
}

async function syncToCloud(){
  await fetch(`https://api.github.com/gists/${GIST_ID}`,{
    method:"PATCH",
    headers:{
      "Authorization":"token "+GIST_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      files:{
        "ielts_words.json":{
          content:JSON.stringify({words,logs},null,2)
        }
      }
    })
  });
}

function save(doSync=true){
  localStorage.setItem("words",JSON.stringify(words));
  localStorage.setItem("logs",JSON.stringify(logs));
  if(doSync){
    if(syncTimer) clearTimeout(syncTimer);
    syncTimer=setTimeout(()=>syncToCloud(),3000);
  }
}

/* ================= å¯åŠ¨ ================= */
document.body.classList.toggle("dark",dark);
syncFromCloud().finally(()=>next());
</script>
</body>
</html>

