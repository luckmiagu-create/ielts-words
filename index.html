<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS å•è¯å…¨ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; background: #f0fdf4; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center; }
        #q { font-size: 32px; margin: 0; cursor: pointer; color: #064e3b; }
        #ph { color: #16a34a; margin: 10px 0; min-height: 1.2em; font-size: 18px; }
        input { width: 100%; padding: 12px; margin: 20px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; outline: none; text-align: center; }
        button { padding: 10px 20px; border: none; border-radius: 10px; background: #16a34a; color: white; cursor: pointer; font-weight: bold; }
        .status { font-size: 12px; color: #94a3b8; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="status" class="status">æ­£åœ¨åŒæ­¥äº‘ç«¯...</div>
    <div class="card">
        <h2 id="q" onclick="speakCurrent()">åŠ è½½ä¸­...</h2>
        <div id="ph" onclick="speakCurrent()"></div>
        <div id="hint" style="font-size: 12px; color: #999;"></div>
        <input type="text" id="input" placeholder="è¾“å…¥ç­”æ¡ˆå¹¶å›è½¦" autocomplete="off">
        <div id="result" style="font-weight: bold; margin-bottom: 5px;"></div>
        <div id="answer" style="color: #64748b; font-size: 14px;"></div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="prev()" style="background:#64748b">ä¸Šä¸€ä¸ª</button>
            <button onclick="speakCurrent()" style="background:#6366f1">ğŸ”Š æœ—è¯»</button>
            <button onclick="next()" style="background:#64748b">ä¸‹ä¸€ä¸ª</button>
        </div>
    </div>
    <div style="margin-top: 20px; text-align: center;">
        <button onclick="toggleAdd()" style="background: #475569;">+ æ·»åŠ /æ‰¹é‡å¯¼å…¥</button>
    </div>
    <div id="addPanel" style="display:none; margin-top: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
        <input type="text" id="newEn" placeholder="å•è¯ (å¦‚: atmosphere)" style="text-align: left;">
        <input type="text" id="newPh" placeholder="éŸ³æ ‡ (å¦‚: /ËˆÃ¦tmÉ™sfÉªÉ™/)" style="text-align: left;">
        <input type="text" id="newCn" placeholder="ä¸­æ–‡ (å¦‚: å¤§æ°”å±‚)" style="text-align: left;">
        <button onclick="add()" style="width: 100%;">å­˜å…¥äº‘ç«¯</button>
        <hr style="margin: 20px 0; border: none; border-top: 1px dashed #eee;">
        <textarea id="batchInput" placeholder="æ‰¹é‡å¯¼å…¥æ ¼å¼: å•è¯:éŸ³æ ‡:ä¸­æ–‡" rows="4" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px;"></textarea>
        <button onclick="batchAdd()" style="width: 100%; margin-top: 10px; background: #059669;">ç¡®è®¤æ‰¹é‡å¯¼å…¥</button>
    </div>

<script>
// åˆå§‹åŒ– (ä½¿ç”¨ä½ æˆªå›¾ä¸­çš„ä¿¡æ¯)
AV.init({
    appId: "ezJjMBF0ioTdPd21imL1RQ8y-gzGzoHsz",
    appKey: "7CGxTy5W8FOeVyJRT1BSqaq3",
    serverURL: "https://ezjjmbf0.lc-cn-n1-shared.com"
});

const STORAGE_ID = "my_ielts_words_v1"; 
let words = JSON.parse(localStorage.getItem("words") || "[]");
let index = 0;

// æœ—è¯»
function speak(text) {
    if (!text) return;
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'en-US';
    window.speechSynthesis.speak(msg);
}
function speakCurrent() { if (words[index]) speak(words[index].en); }

// åŒæ­¥ï¼šä¼˜å…ˆè¯»å–äº‘ç«¯
async function syncFromCloud() {
    const statusEl = document.getElementById("status");
    try {
        const query = new AV.Query('WordData');
        query.equalTo('storageId', STORAGE_ID);
        const record = await query.first();
        if (record) {
            words = record.get('content') || [];
            localStorage.setItem("words", JSON.stringify(words));
            statusEl.textContent = "âœ… äº‘ç«¯å·²åŒæ­¥ (è¯åº“: " + words.length + ")";
        } else { statusEl.textContent = "â˜ï¸ äº‘ç«¯å°šæ— æ•°æ®"; }
    } catch (e) { statusEl.textContent = "âš ï¸ ç¦»çº¿æ¨¡å¼"; }
    render();
}

// ä¿å­˜ï¼šæœ¬åœ°+äº‘ç«¯åŒåŒæ­¥
async function saveToCloud() {
    document.getElementById("status").textContent = "æ­£åœ¨åŒæ­¥è‡³äº‘ç«¯...";
    localStorage.setItem("words", JSON.stringify(words));
    try {
        const query = new AV.Query('WordData');
        query.equalTo('storageId', STORAGE_ID);
        let record = await query.first();
        if (!record) {
            const WordObj = AV.Object.extend('WordData');
            record = new WordObj();
            record.set('storageId', STORAGE_ID);
        }
        record.set('content', words);
        await record.save();
        document.getElementById("status").textContent = "âœ… äº‘ç«¯åŒæ­¥æˆåŠŸ";
    } catch (e) { document.getElementById("status").textContent = "âŒ åŒæ­¥å¤±è´¥"; }
}

function render() {
    if (!words.length) {
        document.getElementById("q").textContent = "è¯åº“ä¸ºç©º";
        document.getElementById("ph").textContent = "";
        return;
    }
    if (index >= words.length) index = 0;
    const current = words[index];
    document.getElementById("q").textContent = current.en;
    document.getElementById("ph").textContent = current.ph ? `[${current.ph}]` : "";
    document.getElementById("hint").textContent = `è¿›åº¦: ${index+1}/${words.length}`;
    document.getElementById("input").value = "";
    document.getElementById("result").textContent = "";
    document.getElementById("answer").textContent = "";
}

function next() { index = (index + 1) % words.length; render(); speakCurrent(); }
function prev() { index = (index - 1 + words.length) % words.length; render(); speakCurrent(); }

document.getElementById("input").onkeydown = e => {
    if (e.key === "Enter") {
        const val = e.target.value.trim().toLowerCase();
        const current = words[index];
        if (current.cn.includes(val)) {
            document.getElementById("result").textContent = "âœ… æ­£ç¡®";
            setTimeout(next, 800);
        } else {
            document.getElementById("result").textContent = "âŒ é”™è¯¯";
            document.getElementById("answer").textContent = "ç­”æ¡ˆ: " + current.cn;
        }
    }
};

function toggleAdd() {
    const p = document.getElementById("addPanel");
    p.style.display = p.style.display === "none" ? "block" : "none";
}

function add() {
    const en = document.getElementById("newEn").value.trim();
    const ph = document.getElementById("newPh").value.trim();
    const cn = document.getElementById("newCn").value.trim();
    if (en && cn) {
        words.push({ en, ph, cn });
        render();
        saveToCloud();
        document.getElementById("newEn").value = "";
        document.getElementById("newPh").value = "";
        document.getElementById("newCn").value = "";
    }
}

function batchAdd() {
    const text = document.getElementById("batchInput").value.trim();
    if (!text) return;
    text.split('\n').forEach(line => {
        const parts = line.split(/[:ï¼š]/);
        if (parts.length >= 2) {
            const en = parts[0].trim();
            const cn = parts[parts.length - 1].trim();
            const ph = parts.length === 3 ? parts[1].trim() : "";
            words.push({ en, ph, cn });
        }
    });
    saveToCloud();
    render();
    document.getElementById("batchInput").value = "";
    toggleAdd();
}

window.onload = syncFromCloud;
</script>
</body>
</html>