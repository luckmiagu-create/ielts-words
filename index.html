<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
<meta name="theme-color" content="#16a34a">
<title>IELTS Words</title>

<script src="https://code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>

<style>
:root{
  --main:#16a34a; --bg:#f0fdf4; --card:#fff;
  --text:#064e3b; --sub:#6b7280; --danger:#dc2626;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:-apple-system,system-ui;
  background:var(--bg);color:var(--text)
}
.app{max-width:420px;margin:auto;padding:16px 16px 100px}
.card{
  background:var(--card);border-radius:24px;padding:24px;
  box-shadow:0 12px 35px rgba(22,163,74,.15);
  text-align:center;min-height:260px
}
.question{font-size:32px;font-weight:700;margin:10px 0}
.hint{color:var(--sub);font-size:14px;margin-bottom:10px}
input,textarea{
  width:100%;padding:14px;font-size:16px;
  border-radius:14px;border:2px solid #d1fae5;
}
input:focus{border-color:var(--main)}
.result{margin-top:12px;font-size:20px;font-weight:700}
.correct{color:var(--main)}
.wrong{color:var(--danger)}
.answer{margin-top:6px;color:var(--sub)}
.row{display:flex;gap:10px;margin-bottom:16px}
button{
  flex:1;padding:12px;border:none;border-radius:14px;
  background:var(--main);color:#fff;font-weight:600
}
.secondary{background:#e5e7eb;color:#374151}
.fab{
  position:fixed;right:20px;bottom:20px;
  width:60px;height:60px;border-radius:30px;
  background:var(--main);color:#fff;
  font-size:34px;display:flex;
  align-items:center;justify-content:center;
  box-shadow:0 10px 25px rgba(0,0,0,.3)
}
.panel{
  position:fixed;left:0;right:0;bottom:0;
  background:#fff;border-radius:28px 28px 0 0;
  padding:24px;display:none;max-height:85vh;overflow:auto
}
.word-item{
  display:flex;justify-content:space-between;
  padding:12px 0;border-bottom:1px solid #eee
}
</style>
</head>

<body>
<div class="app">

<div class="row">
  <button onclick="setMode('en2cn')" id="btnEn">英→汉</button>
  <button onclick="setMode('cn2en')" id="btnCn" class="secondary">汉→英</button>
  <button onclick="togglePool()" id="btnPool" class="secondary">全部</button>
</div>

<div class="card">
  <div id="syncStatus" style="font-size:10px;text-align:right;color:#9ca3af">同步中…</div>
  <div class="question" id="q">加载中…</div>
  <div class="hint" id="hint"></div>
  <input id="input" placeholder="输入答案 回车">
  <div class="result" id="result"></div>
  <div class="answer" id="answer"></div>
</div>

<div class="row" style="margin-top:20px">
  <button onclick="prev()" class="secondary">←</button>
  <button onclick="next()" class="secondary">→</button>
</div>

</div>

<div class="fab" onclick="toggleAdd()">+</div>

<div id="addPanel" class="panel">
  <h3>添加单词</h3>
  <input id="newEn" placeholder="英文">
  <input id="newCn" placeholder="中文">
  <button onclick="add()">保存</button>
  <hr>
  <textarea id="batchInput" placeholder="apple:苹果"></textarea>
  <button onclick="batchAdd()">批量导入</button>
</div>

<script>
/* ========== LeanCloud 初始化 ========== */
AV.init({
  appId:"ezJjMBF0ioTdPd21imL1RQ8y-gzGzoHsz",
  appKey:"7CGxTy5W8FOeVyJRT1BSqaq3",
  serverURL:"https://ezjjmbf0.lc-cn-n1-shared.com"
});

/* ========== 数据 ========== */
const STORAGE_ID="ielts_words_main";
let words=JSON.parse(localStorage.getItem("words"))||[];
let index=0,mode="en2cn",pool="all";

/* ========== 合并函数（关键） ========== */
function mergeWords(local=[],remote=[]){
  const map={};
  remote.forEach(w=>map[w.en]=w);
  local.forEach(w=>map[w.en]={...map[w.en],...w});
  return Object.values(map);
}

/* ========== 同步 ========== */
async function syncFromCloud(){
  const q=new AV.Query("WordData");
  q.equalTo("storageId",STORAGE_ID);
  const r=await q.first();
  if(r){
    words=mergeWords(words,r.get("content")||[]);
    localStorage.setItem("words",JSON.stringify(words));
  }
  render();
  syncStatus.textContent="已同步";
}

async function save(){
  localStorage.setItem("words",JSON.stringify(words));
  const q=new AV.Query("WordData");
  q.equalTo("storageId",STORAGE_ID);
  let r=await q.first();
  if(!r){
    r=new (AV.Object.extend("WordData"))();
    r.set("storageId",STORAGE_ID);
  }
  r.set("content",words);
  await r.save();
  syncStatus.textContent="已上传";
}

/* ========== 逻辑 ========== */
function list(){return pool==="wrong"?words.filter(w=>w.wrong):words}

function render(){
  const l=list();
  if(!l.length){
    q.textContent="暂无单词";
    hint.textContent="点击 + 添加";
    return;
  }
  if(index>=l.length)index=0;
  const c=l[index];
  q.textContent=mode==="en2cn"?c.en:c.cn;
  hint.textContent=`${index+1}/${l.length}`;
  input.value="";result.textContent="";answer.textContent="";
}

input.onkeydown=e=>{
  if(e.key==="Enter"){
    const v=input.value.trim().toLowerCase();
    const c=list()[index];
    const ok=mode==="en2cn"?c.cn.includes(v):v===c.en;
    if(ok){
      result.textContent="✅ 正确";
      result.className="result correct";
      c.wrong=0; save();
      setTimeout(next,600);
    }else{
      result.textContent="❌ 错误";
      result.className="result wrong";
      c.wrong=1; save();
      answer.textContent="答案："+(mode==="en2cn"?c.cn:c.en);
    }
  }
}

function next(){index++;render()}
function prev(){index--;render()}
function setMode(m){mode=m;btnEn.className=m==="en2cn"?"":"secondary";btnCn.className=m==="cn2en"?"":"secondary";render()}
function togglePool(){pool=pool==="all"?"wrong":"all";btnPool.textContent=pool==="all"?"全部":"错题";render()}

/* ========== 添加 ========== */
function toggleAdd(){addPanel.style.display=addPanel.style.display?"":"block"}
function add(){
  if(!newEn.value||!newCn.value)return;
  words.push({en:newEn.value.toLowerCase(),cn:newCn.value,wrong:0});
  save();toggleAdd();render();
  newEn.value=newCn.value="";
}
function batchAdd(){
  batchInput.value.split("\n").forEach(l=>{
    const [en,cn]=l.split(/[:：]/);
    if(en&&cn)words.push({en:en.trim().toLowerCase(),cn:cn.trim(),wrong:0});
  });
  save();toggleAdd();render();batchInput.value="";
}

/* ========== 启动 ========== */
syncFromCloud();
</script>
</body>
</html>
