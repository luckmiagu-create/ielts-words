<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>IELTS å•è¯å…¨ç«¯åŒæ­¥ - æƒé™ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        :root { --main: #16a34a; --bg: #f0fdf4; --card: #fff; --text: #064e3b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .status { font-size: 12px; color: #94a3b8; margin-bottom: 10px; height: 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 30px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(22,163,74,0.1); text-align: center; }
        #q { font-size: 32px; margin: 10px 0; cursor: pointer; }
        #ph { color: var(--main); font-size: 18px; margin-bottom: 15px; min-height: 1.2em; cursor: pointer; }
        input { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #d1fae5; border-radius: 12px; outline: none; text-align: center; }
        button { padding: 12px 20px; border: none; border-radius: 12px; background: var(--main); color: white; font-weight: bold; cursor: pointer; margin: 5px; flex: 1; }
        .btn-group { display: flex; width: 100%; max-width: 400px; margin-top: 15px; }
        #addPanel { display: none; background: white; border-radius: 15px; padding: 20px; margin-top: 20px; width: 100%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="status" class="status">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</div>

    <div class="card">
        <h2 id="q" onclick="speakCurrent()">åŠ è½½ä¸­...</h2>
        <div id="ph" onclick="speakCurrent()"></div>
        <div id="hint" style="font-size: 12px; color: #94a3b8; margin-bottom: 10px;"></div>

        <input type="text" id="input" placeholder="è¾“å…¥ç­”æ¡ˆå¹¶å›è½¦" autocomplete="off">
        <div id="result" style="margin-top: 15px; font-weight: bold; height: 24px;"></div>
        <div id="answer" style="color: #2563eb; font-size: 14px; margin-top: 5px; height: 20px;"></div>
        
        <div class="btn-group">
            <button onclick="prev()" style="background:#64748b">â†</button>
            <button onclick="speakCurrent()" style="background:#6366f1">ğŸ”Š æœ—è¯»</button>
            <button onclick="next()" style="background:#64748b">â†’</button>
        </div>
    </div>

    <button onclick="toggleAdd()" style="margin-top: 20px; background: #475569; width: 100%; max-width: 400px;">+ æ·»åŠ æˆ–æ‰¹é‡å¯¼å…¥å•è¯</button>

    <div id="addPanel">
        <input type="text" id="newEn" placeholder="å•è¯ (å¦‚: atmosphere)" style="text-align: left; margin-bottom: 10px;">
        <input type="text" id="newPh" placeholder="éŸ³æ ‡ (å¦‚: /ËˆÃ¦tmÉ™sfÉªÉ™/)" style="text-align: left; margin-bottom: 10px;">
        <input type="text" id="newCn" placeholder="ä¸­æ–‡ (å¦‚: å¤§æ°”å±‚)" style="text-align: left; margin-bottom: 10px;">
        <button onclick="add()" style="width: 100%; margin: 0 0 15px 0;">å­˜å…¥äº‘åº“</button>
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">æ‰¹é‡æ ¼å¼ï¼šå•è¯:éŸ³æ ‡:å«ä¹‰ (æ¯è¡Œä¸€ä¸ª)</div>
        <textarea id="batchInput" rows="4" style="width:100%; border:1px solid #d1fae5; border-radius:10px; padding:10px; outline:none;"></textarea>
        <button onclick="batchAdd()" style="width: 100%; margin-top: 10px; background: #059669;">ç¡®è®¤æ‰¹é‡å¯¼å…¥</button>
    </div>

<script>
/* ======================
    1. åˆå§‹åŒ–é…ç½®
====================== */
AV.init({
    appId: "ezJjMBF0ioTdPd21imL1RQ8y-gzGzoHsz",
    appKey: "7CGxTy5W8FOeVyJRT1BSqaq3",
    serverURL: "https://ezjjmbf0.lc-cn-n1-shared.com"
});

const STORAGE_ID = "my_ielts_words_v1"; 
let words = JSON.parse(localStorage.getItem("words") || "[]");
let index = 0;

/* ======================
    2. è¯­éŸ³åŠŸèƒ½
====================== */
function speak(text) {
    if (!text) return;
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'en-US';
    window.speechSynthesis.speak(msg);
}
function speakCurrent() { if (words[index]) speak(words[index].en); }

/* ======================
    3. äº‘åŒæ­¥æ ¸å¿ƒé€»è¾‘ (æƒé™ä¿®å¤ç‰ˆ)
====================== */
async function syncFromCloud() {
    const statusEl = document.getElementById("status");
    try {
        const query = new AV.Query('WordData');
        query.equalTo('storageId', STORAGE_ID);
        const record = await query.first();
        
        if (record) {
            words = record.get('content') || [];
            localStorage.setItem("words", JSON.stringify(words));
            statusEl.textContent = "âœ… äº‘ç«¯åŒæ­¥å®Œæˆ (å½“å‰: " + words.length + " ä¸ªè¯)";
        } else {
            statusEl.textContent = "â˜ï¸ äº‘ç«¯å°šæ— æ•°æ®";
        }
    } catch (e) {
        statusEl.textContent = "âš ï¸ ç¦»çº¿æ¨¡å¼: " + e.message;
    }
    render();
}

async function saveToCloud() {
    const statusEl = document.getElementById("status");
    statusEl.textContent = "æ­£åœ¨åŒæ­¥è‡³äº‘ç«¯...";
    localStorage.setItem("words", JSON.stringify(words));
    
    try {
        const query = new AV.Query('WordData');
        query.equalTo('storageId', STORAGE_ID);
        let record = await query.first();
        
        if (!record) {
            const WordObj = AV.Object.extend('WordData');
            record = new WordObj();
            record.set('storageId', STORAGE_ID);
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶è®¾ç½®æ‰€æœ‰äººå¯è¯»å†™æƒé™ ---
        const acl = new AV.ACL();
        acl.setPublicReadAccess(true);
        acl.setPublicWriteAccess(true); 
        record.setACL(acl); 
        // -----------------------------------------------------------

        record.set('content', words);
        await record.save();
        statusEl.textContent = "âœ… äº‘ç«¯åŒæ­¥æˆåŠŸ (è¯åº“: " + words.length + ")";
    } catch (e) {
        console.error(e);
        statusEl.textContent = "âŒ åŒæ­¥å¤±è´¥: " + e.message;
    }
}

/* ======================
    4. ä¸šåŠ¡é€»è¾‘
====================== */
function render() {
    if (words.length === 0) {
        document.getElementById("q").textContent = "è¯åº“ä¸ºç©º";
        document.getElementById("ph").textContent = "";
        document.getElementById("hint").textContent = "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ·»åŠ ";
        return;
    }
    if (index >= words.length) index = 0;
    if (index < 0) index = words.length - 1;

    const current = words[index];
    document.getElementById("q").textContent = current.en;
    document.getElementById("ph").textContent = current.ph ? `[${current.ph}]` : "";
    document.getElementById("hint").textContent = `è¿›åº¦: ${index + 1} / ${words.length}`;
    document.getElementById("input").value = "";
    document.getElementById("result").textContent = "";
    document.getElementById("answer").textContent = "";
    speak(current.en);
}

function next() { index++; render(); }
function prev() { index--; render(); }

document.getElementById("input").onkeydown = e => {
    if (e.key === "Enter") {
        const val = e.target.value.trim().toLowerCase();
        const current = words[index];
        if (current.cn.replace(/\s/g,"").includes(val.replace(/\s/g,""))) {
            document.getElementById("result").textContent = "âœ… æ­£ç¡®";
            document.getElementById("result").style.color = "#16a34a";
            setTimeout(next, 800);
        } else {
            document.getElementById("result").textContent = "âŒ é”™è¯¯";
            document.getElementById("result").style.color = "#dc2626";
            document.getElementById("answer").textContent = "æ­£ç¡®ç­”æ¡ˆ: " + current.cn;
            speak(current.en);
        }
    }
};

function toggleAdd() {
    const p = document.getElementById("addPanel");
    p.style.display = p.style.display === "none" ? "block" : "none";
}

function add() {
    const en = document.getElementById("newEn").value.trim();
    const ph = document.getElementById("newPh").value.trim();
    const cn = document.getElementById("newCn").value.trim();
    if (en && cn) {
        words.push({ en, ph, cn });
        render();
        saveToCloud();
        document.getElementById("newEn").value = "";
        document.getElementById("newPh").value = "";
        document.getElementById("newCn").value = "";
    }
}

function batchAdd() {
    const text = document.getElementById("batchInput").value.trim();
    if (!text) return;
    text.split('\n').forEach(line => {
        const parts = line.split(/[:ï¼š]/);
        if (parts.length >= 2) {
            const en = parts[0].trim();
            const cn = parts[parts.length - 1].trim();
            const ph = parts.length === 3 ? parts[1].trim() : "";
            words.push({ en, ph, cn });
        }
    });
    saveToCloud();
    render();
    document.getElementById("batchInput").value = "";
    toggleAdd();
}

window.onload = syncFromCloud;
</script>
</body>
</html>