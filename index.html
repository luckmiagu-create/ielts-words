<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é›…æ€å•è¯è®°å¿† Â· äº‘åŒæ­¥ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4f46e5">
<link rel="manifest" href="manifest.json">

<style>
:root{--bg:#f5f7fa;--card:#fff;--text:#111;--sub:#6b7280;--btn:#4f46e5}
.dark{--bg:#111827;--card:#1f2937;--text:#f9fafb;--sub:#9ca3af;--btn:#6366f1}
body{margin:0;background:var(--bg);color:var(--text);
font-family:Arial,"PingFang SC","Microsoft YaHei"}
.app{max-width:860px;margin:auto;padding:16px}
.card{background:var(--card);padding:20px;border-radius:16px;
box-shadow:0 8px 18px rgba(0,0,0,.15)}
h1{text-align:center}
.row{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:8px 0}
button{padding:8px 14px;border:none;border-radius:8px;
background:var(--btn);color:#fff;cursor:pointer}
.secondary{background:#64748b}
.question{font-size:26px;font-weight:bold;text-align:center}
.hint{text-align:center;color:var(--sub);margin-top:6px}
input{width:80%;padding:10px;font-size:18px;margin:12px auto;display:block}
.answer{text-align:center;margin-top:8px;display:none}
.stats{text-align:center;font-size:14px;color:var(--sub);margin-top:10px}
</style>

<script>
if("serviceWorker"in navigator){
  window.addEventListener("load",()=>navigator.serviceWorker.register("service-worker.js"));
}
</script>
</head>

<body>
<div class="app">
<h1>é›…æ€å•è¯è®°å¿† Â· äº‘åŒæ­¥ç‰ˆ</h1>

<div class="row">
  <button onclick="setMode('en2cn')">è‹±â†’æ±‰</button>
  <button onclick="setMode('cn2en')" class="secondary">æ±‰â†’è‹±</button>
  <button onclick="toggleDark()" class="secondary">ğŸŒ™</button>
</div>

<div class="row">
  <button onclick="setPool('all')">ğŸ“š å…¨éƒ¨</button>
  <button onclick="setPool('due')" class="secondary">â° ä»Šæ—¥</button>
  <button onclick="setPool('wrong')" class="secondary">ğŸ“• é”™è¯</button>
</div>

<div class="card" id="card">
  <div class="question" id="q"></div>
  <div class="hint" id="hint"></div>
  <input id="input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
  <div class="answer" id="answer"></div>
</div>

<div class="row">
  <button onclick="grade(true)">âœ” è®°ä½</button>
  <button onclick="grade(false)" class="secondary">âœ– å¿˜è®°</button>
  <button onclick="showAnswer()">ğŸ‘€ ç­”æ¡ˆ</button>
</div>

<div class="row">
  <button onclick="syncFromCloud()" class="secondary">â˜ï¸ æ‹‰å–äº‘ç«¯</button>
  <button onclick="syncToCloud()" class="secondary">â˜ï¸ ä¸Šä¼ äº‘ç«¯</button>
</div>

<div class="stats" id="stats"></div>
</div>

<script>
/* ================== ğŸ”§ äº‘åŒæ­¥é…ç½®ï¼ˆåªæ”¹è¿™é‡Œï¼‰ ================== */
const GIST_ID = "ä½ çš„_GIST_ID";
const GIST_TOKEN = "ä½ çš„_GITHUB_TOKEN";
/* ============================================================ */

const DAY=86400000;
let mode="en2cn", pool="all", current=null;
let dark=localStorage.getItem("dark")==="1";

let words=JSON.parse(localStorage.getItem("words"))||[
  make("abandon","æ”¾å¼ƒ"),make("accurate","å‡†ç¡®çš„"),make("analyze","åˆ†æ")
];
let logs=JSON.parse(localStorage.getItem("logs"))||[];

function make(en,cn){
  return{en,cn,ease:2.5,interval:0,due:0,wrong:0}
}

function schedule(w,ok){
  if(ok){
    w.ease=Math.max(1.3,w.ease+0.1);
    w.interval=w.interval?Math.round(w.interval*w.ease):1;
    w.wrong=0;
  }else{
    w.ease=Math.max(1.3,w.ease-0.2);
    w.interval=1;
    w.wrong++;
  }
  w.due=Date.now()+w.interval*DAY;
}

function getPool(){
  if(pool==="due")return words.filter(w=>w.due<=Date.now());
  if(pool==="wrong")return words.filter(w=>w.wrong||w.ease<2.3);
  return words;
}

function setMode(m){mode=m;next()}
function setPool(p){pool=p;next()}
function showAnswer(){answer.style.display="block"}

function toggleDark(){
  dark=!dark;
  document.body.classList.toggle("dark",dark);
  localStorage.setItem("dark",dark?"1":"0");
}

function next(){
  const list=getPool();
  if(!list.length){q.textContent="ğŸ‰ æš‚æ— å¯å¤ä¹ ";return}
  current=list[Math.floor(Math.random()*list.length)];
  render();
}

function render(){
  q.textContent=(mode==="cn2en"?"æ±‰è¯‘è‹±ï¼š":"è‹±è¯‘æ±‰ï¼š")+
    (mode==="cn2en"?current.cn:current.en);
  hint.textContent=mode==="cn2en"
    ?current.en.slice(0,2)+" _ ".repeat(current.en.length-2)
    :current.cn[0]+"â–¡".repeat(current.cn.length-1);
  answer.textContent="ç­”æ¡ˆï¼š"+(mode==="cn2en"?current.en:current.cn);
  answer.style.display="none";
  input.value="";
  stats.textContent=statText();
}

function grade(ok){
  if(ok){
    const v=input.value.trim();
    if(mode==="cn2en" && v.toLowerCase()!==current.en) ok=false;
    if(mode==="en2cn" && !current.cn.includes(v)) ok=false;
  }
  schedule(current,ok);
  logs.push({t:Date.now(),ok});
  save(); next();
}

function statText(){
  const now=Date.now();
  const d7=logs.filter(l=>now-l.t<7*DAY).length;
  const d30=logs.filter(l=>now-l.t<30*DAY).length;
  return `ä»Šæ—¥ï¼š${getPool().length}ï½œ7å¤©ï¼š${d7}ï½œ30å¤©ï¼š${d30}`;
}

/* ========== â˜ï¸ äº‘åŒæ­¥æ ¸å¿ƒ ========== */
async function syncToCloud(){
  await fetch(`https://api.github.com/gists/${GIST_ID}`,{
    method:"PATCH",
    headers:{
      "Authorization":"token "+GIST_TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      files:{
        "ielts_words.json":{
          content:JSON.stringify({words,logs},null,2)
        }
      }
    })
  });
  alert("å·²ä¸Šä¼ äº‘ç«¯");
}

async function syncFromCloud(){
  const r=await fetch(`https://api.github.com/gists/${GIST_ID}`);
  const j=await r.json();
  const data=JSON.parse(j.files["ielts_words.json"].content);
  words=data.words||[];
  logs=data.logs||[];
  save(); next();
  alert("å·²åŒæ­¥äº‘ç«¯");
}
/* ================================= */

function save(){
  localStorage.setItem("words",JSON.stringify(words));
  localStorage.setItem("logs",JSON.stringify(logs));
}

document.body.classList.toggle("dark",dark);
next();
</script>
</body>
</html>
